<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PresentationFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Election Results Core</a> &gt; <a href="index.source.html" class="el_package">de.larssh.election.germany.schleswigholstein.local.file</a> &gt; <span class="el_source">PresentationFiles.java</span></div><h1>PresentationFiles.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Jan 30 16:29:34 UTC 2023
package de.larssh.election.germany.schleswigholstein.local.file;

import static de.larssh.utils.Collectors.toLinkedHashSet;
import static java.util.stream.Collectors.joining;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.io.Writer;
import java.lang.invoke.MethodHandles;
import java.math.BigDecimal;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Locale;
import java.util.Optional;
import java.util.OptionalInt;
import java.util.Set;
import java.util.function.Supplier;
import de.larssh.election.germany.schleswigholstein.Color;
import de.larssh.election.germany.schleswigholstein.Party;
import de.larssh.election.germany.schleswigholstein.local.LocalBallot;
import de.larssh.election.germany.schleswigholstein.local.LocalElectionResult;
import de.larssh.election.germany.schleswigholstein.local.LocalNominationResult;
import de.larssh.election.germany.schleswigholstein.local.LocalNominationResultType;
import de.larssh.election.germany.schleswigholstein.local.LocalNominationType;
import de.larssh.election.germany.schleswigholstein.local.LocalPartyResult;
import de.larssh.election.germany.schleswigholstein.local.LocalPollingStation;
import de.larssh.election.utils.BigDecimals;
import de.larssh.utils.Finals;
import de.larssh.utils.OptionalInts;
import de.larssh.utils.annotations.PackagePrivate;
import de.larssh.utils.io.Resources;
import de.larssh.utils.text.Strings;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * This class contains helper methods to write a result file for live
 * presentations.
 */
@SuppressWarnings(&quot;PMD.ExcessiveImports&quot;)
public final class PresentationFiles {
	/**
	 * Formats and writes {@code result} to {@code writer}.
	 *
	 * @param result      the election result to to write
	 * @param refreshRate the refresh rate of the HTML file or empty
	 * @param writer      the live presentation file writer
	 * @throws IOException on IO error
	 */
	public static void write(final LocalElectionResult result, final Optional&lt;Duration&gt; refreshRate, final Writer writer) throws IOException {
<span class="fc" id="L56">		new PresentationFileWriter(result, refreshRate, writer).write();</span>
<span class="fc" id="L57">	}</span>


	/**
	 * This class writes data of a {@link LocalElectionResult} to a live
	 * presentation file.
	 */
	@SuppressFBWarnings(value = &quot;VA_FORMAT_STRING_USES_NEWLINE&quot;, justification = &quot;Creating system independent output by design&quot;)
	private static class PresentationFileWriter {
		/**
		 * The value 100 as long
		 */
		private static final long HUNDRED = 100;
		/**
		 * Template file body (lazily loaded)
		 */
<span class="fc" id="L73">		private static final Supplier&lt;String&gt; TEMPLATE = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template.html&quot;));</span>
		/**
		 * Template file body for the nomination result view (lazily loaded)
		 */
<span class="fc" id="L77">		private static final Supplier&lt;String&gt; TEMPLATE_NOMINATION_RESULT = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template-nominationResult.html&quot;));</span>
		/**
		 * Template file body for the party result view (lazily loaded)
		 */
<span class="fc" id="L81">		private static final Supplier&lt;String&gt; TEMPLATE_PARTY_RESULT = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template-partyResult.html&quot;));</span>
		/**
		 * Template file body for the polling station view (lazily loaded)
		 */
<span class="fc" id="L85">		private static final Supplier&lt;String&gt; TEMPLATE_POLLING_STATION = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template-pollingStation.html&quot;));</span>
		/**
		 * Time zone for time stamps in presentation files
		 */
<span class="fc" id="L89">		private static final ZoneId TIME_ZONE = ZoneId.of(&quot;Europe/Berlin&quot;);</span>

		/**
		 * Loads a resource from a folder next to this class. The file name is build by
		 * concatenating the class name, a dash and {@code fileNameSuffix}.
		 *
		 * @param fileNameSuffix the file name's suffix
		 * @return the resource file content
		 */
		@SuppressFBWarnings(value = {&quot;EXS_EXCEPTION_SOFTENING_NO_CONSTRAINTS&quot;, &quot;PATH_TRAVERSAL_IN&quot;}, justification = &quot;IOExceptions in here are not expected to be related to user input or behavior and fileNameSuffix is expected to be a constant value within this class.&quot;)
		private static String loadResourceRelativeToClass(final String fileNameSuffix) {
<span class="fc" id="L100">			final Class&lt;?&gt; clazz = MethodHandles.lookup().lookupClass();</span>
<span class="fc" id="L101">			final String fileName = clazz.getSimpleName() + &quot;-&quot; + fileNameSuffix;</span>
<span class="pc" id="L102">			final Path path = Resources.getResourceRelativeTo(clazz, Paths.get(fileName)).orElseThrow(() -&gt; new IllegalArgumentException(Strings.format(&quot;Failed loading the resource file \&quot;%s\&quot; relative to class \&quot;%s\&quot;.&quot;, fileName, clazz.getName())));</span>
			try {
<span class="fc" id="L104">				return new String(Files.readAllBytes(path), Strings.DEFAULT_CHARSET);</span>
<span class="nc" id="L105">			} catch (final IOException e) {</span>
<span class="nc" id="L106">				throw new UncheckedIOException(e);</span>
			}
		}

		/**
		 * Encodes {@code value} according to the XML standards.
		 *
		 * @param value the value to encode
		 * @return the encoded value
		 */
		private static String encodeXml(final String value) {
<span class="fc" id="L117">			return value.replace(&quot;&amp;&quot;, &quot;&amp;amp;&quot;).replace(&quot;&lt;&quot;, &quot;&amp;lt;&quot;).replace(&quot;&gt;&quot;, &quot;&amp;gt;&quot;).replace(&quot;\&quot;&quot;, &quot;&amp;quot;&quot;).replace(&quot;\'&quot;, &quot;&amp;apos;&quot;).replace(&quot;\r&quot;, &quot;&amp;#13;&quot;).replace(&quot;\n&quot;, &quot;&amp;#10;&quot;);</span>
		}

		/**
		 * Election Result to write
		 *
		 * @return the election result to write
		 */
		private final LocalElectionResult result;
		/**
		 * Refresh rate of the HTML file or empty if the page shall not refresh
		 * automatically
		 *
		 * @return the refresh rate of the HTML file or empty
		 */
		private final Optional&lt;Duration&gt; refreshRate;
		/**
		 * Live presentation file writer
		 *
		 * @return the live presentation file writer
		 */
		private final Writer writer;

		/**
		 * Formats and writes {@link #result} to {@link #writer}.
		 *
		 * @throws IOException on IO error
		 */
		@PackagePrivate
		@SuppressFBWarnings(value = &quot;OI_OPTIONAL_ISSUES_USES_IMMEDIATE_EXECUTION&quot;, justification = &quot;The value 0L is nothing that needs to be executed.&quot;)
		void write() throws IOException {
<span class="fc" id="L148">			writer.write(String.format(TEMPLATE.get(), refreshRate.map(Duration::toMillis).orElse(0L), result.getElection().getDate(), formatPollingStations(), formatNominationResults(), formatPartyResults(), LocalDateTime.now(TIME_ZONE)));</span>
<span class="fc" id="L149">		}</span>

		/**
		 * Formats the polling stations overview.
		 *
		 * @return the polling stations overview
		 */
		private String formatPollingStations() {
<span class="fc" id="L157">			final Set&lt;LocalPollingStation&gt; pollingStations = result.getElection().getPollingStations();</span>
<span class="fc" id="L158">			final BigDecimal evaluationProgressIfUnknown = BigDecimals.divide(HUNDRED, pollingStations.size(), 1);</span>
<span class="fc" id="L159">			return pollingStations.stream().map(pollingStation -&gt; formatPollingStation(pollingStation, estimateNumberOfAllBallots(pollingStations), evaluationProgressIfUnknown)).collect(joining());</span>
		}

		/**
		 * Returns the exact number of all ballots if available. ELse the number of all
		 * ballots is estimated.
		 *
		 * @param pollingStations the polling stations
		 * @return the estimated number of all ballots
		 */
		@SuppressWarnings(&quot;checkstyle:MagicNumber&quot;)
		private BigDecimal estimateNumberOfAllBallots(final Set&lt;LocalPollingStation&gt; pollingStations) {
			// Start by calculating the known numbers of ballots
<span class="fc" id="L172">			int numberOfPresent = 0;</span>
<span class="fc" id="L173">			int sumOfAllBallots = 0;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">			for (final LocalPollingStation pollingStation : pollingStations) {</span>
<span class="fc" id="L175">				final OptionalInt numberOfAllBallots = result.getNumberOfAllBallots(pollingStation);</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">				if (numberOfAllBallots.isPresent()) {</span>
<span class="fc" id="L177">					sumOfAllBallots += numberOfAllBallots.getAsInt();</span>
<span class="fc" id="L178">					numberOfPresent += 1;</span>
				}
<span class="fc" id="L180">			}</span>
			// In case no information about the number of ballots is available, let's
			// estimate exactly one ballot per polling station.
<span class="fc bfc" id="L183" title="All 2 branches covered.">			if (numberOfPresent == 0) {</span>
<span class="fc" id="L184">				return BigDecimal.valueOf(pollingStations.size() - numberOfPresent);</span>
			}
			// Increase the sum of known ballots proportionally
<span class="fc" id="L187">			return BigDecimals.divide((long) sumOfAllBallots * pollingStations.size(), numberOfPresent, 3);</span>
		}

		/**
		 * Formats the given {@code pollingStation}.
		 *
		 * @param pollingStation              the polling station to format
		 * @param estimatedNumberOfAllBallots the estimated number of all ballots
		 * @param evaluationProgressIfUnknown the evaluation progress in case the number
		 *                                    of all ballots is unknown
		 * @return the formatted polling station
		 */
		private String formatPollingStation(final LocalPollingStation pollingStation, final BigDecimal estimatedNumberOfAllBallots, final BigDecimal evaluationProgressIfUnknown) {
<span class="fc" id="L200">			final BigDecimal evaluationProgress = result.getEvaluationProgress(1, pollingStation).orElse(BigDecimal.ZERO);</span>
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">			return String.format(Locale.ROOT, TEMPLATE_POLLING_STATION.get(), pollingStation.getBackgroundColor().toHex(), pollingStation.getFontColor().toHex(), OptionalInts.mapToObj(result.getNumberOfAllBallots(pollingStation), numOfBallots -&gt; BigDecimals.isZero(estimatedNumberOfAllBallots) ? null : BigDecimals.divide(HUNDRED * numOfBallots, estimatedNumberOfAllBallots, 1)).orElse(evaluationProgressIfUnknown), encodeXml(formatPollingStationTitle(pollingStation)), encodeXml(pollingStation.getName()), BigDecimals.format(evaluationProgress, 1, Locale.GERMAN), evaluationProgress);</span>
		}

		/**
		 * Formats the {@code title} attribute for the given {@code pollingStation}.
		 *
		 * @param pollingStation the polling station to format
		 * @return the formatted polling station {@code title} attribute
		 */
		private String formatPollingStationTitle(final LocalPollingStation pollingStation) {
<span class="fc bfc" id="L211" title="All 2 branches covered.">			return formatPollingStationTitlePart(result.getBallots(pollingStation).size(), result.getNumberOfAllBallots(pollingStation), (int) result.getBallots(pollingStation).stream().filter(ballot -&gt; !ballot.isValid()).count(), result.getElection().getNumberOfEligibleVoters(pollingStation)) + String.format(Locale.GERMAN, &quot;\n\nGesamt: %.1f %%\n&quot;, result.getEvaluationProgress(1).orElse(BigDecimal.ZERO)) + formatPollingStationTitlePart(result.getBallots().size(), result.getNumberOfAllBallots(), result.getNumberOfInvalidBallots(), result.getElection().getNumberOfEligibleVoters());</span>
		}

		/**
		 * Supports formatting the {@code title} attribute by formatting one section
		 * (part).
		 *
		 * @param numberOfEvaluatedBallots the number of already evaluated ballots
		 * @param numberOfAllBallots       the number of all ballots
		 * @param numberOfInvalidBallots   the number of already evaluated invalid
		 *                                 ballots
		 * @param numberOfEligibleVoters   the number of eligible voters
		 * @return the formatted title part
		 */
		private String formatPollingStationTitlePart(final int numberOfEvaluatedBallots, final OptionalInt numberOfAllBallots, final int numberOfInvalidBallots, final OptionalInt numberOfEligibleVoters) {
<span class="fc" id="L226">			final StringBuilder builder = new StringBuilder();</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">			if (numberOfAllBallots.isPresent()) {</span>
<span class="fc" id="L228">				builder.append(String.format(&quot;%d Stimmzettel\ndavon %d ausgezählt\ndavon %d ungültig&quot;, numberOfAllBallots.getAsInt(), numberOfEvaluatedBallots, numberOfInvalidBallots));</span>
			} else {
<span class="fc" id="L230">				builder.append(String.format(&quot;%d Stimmzettel ausgezählt\ndavon %d ungültig&quot;, numberOfEvaluatedBallots, numberOfInvalidBallots));</span>
			}
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">			if (numberOfEligibleVoters.isPresent()) {</span>
<span class="fc" id="L233">				builder.append(String.format(&quot;\n\n%d Stimmberechtigte&quot;, numberOfEligibleVoters.getAsInt()));</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">				if (numberOfAllBallots.isPresent()) {</span>
<span class="fc" id="L235">					builder.append(String.format(Locale.GERMAN, &quot;\nWahlbeteiligung: %.1f %%&quot;, BigDecimals.divide(HUNDRED * numberOfAllBallots.getAsInt(), numberOfEligibleVoters.getAsInt(), 1)));</span>
				}
			}
<span class="fc" id="L238">			return builder.toString();</span>
		}

		/**
		 * Formats the nomination results overview.
		 *
		 * @return the nomination results overview
		 */
		private String formatNominationResults() {
<span class="fc" id="L247">			final int maxNumberOfVotes = result.getNominationResults().values().stream().map(LocalNominationResult::getNumberOfVotes).max(Integer::compare).orElse(0);</span>
<span class="pc bpc" id="L248" title="1 of 4 branches missed.">			return result.getNominationResults().values().stream().filter(nominationResult -&gt; nominationResult.getNomination().getType() == LocalNominationType.DIRECT || nominationResult.getType() != LocalNominationResultType.NOT_ELECTED).map(nominationResult -&gt; formatNominationResult(nominationResult, maxNumberOfVotes)).collect(joining());</span>
		}

		/**
		 * Formats the given nomination {@code result}.
		 *
		 * @param result           the nomination result to format
		 * @param maxNumberOfVotes the max number of votes of all nomination results
		 * @return the formatted nomination result
		 */
		private String formatNominationResult(final LocalNominationResult result, final int maxNumberOfVotes) {
<span class="fc" id="L259">			return String.format(Locale.ROOT, TEMPLATE_NOMINATION_RESULT.get(), Strings.toLowerCaseAscii(result.getType().toString()), result.getCertainResultType().map(certain -&gt; &quot;certain-&quot; + Strings.toLowerCaseAscii(certain.toString())).orElse(&quot;uncertain&quot;), encodeXml(formatNominationResultTitle(result)), encodeXml(result.getNomination().getPerson().getKey()), result.getNumberOfVotes(), result.getNomination().getParty().map(Party::getBackgroundColor).orElse(Color.BLACK).toHex(), result.getNomination().getParty().map(Party::getFontColor).orElse(Color.WHITE).toHex(), BigDecimals.divideOrZero(HUNDRED * result.getNumberOfVotes(), maxNumberOfVotes, 1));</span>
		}

		/**
		 * Formats the {@code title} attribute for the given nomination {@code result}.
		 *
		 * @param result the nomination result to format
		 * @return the formatted nomination result {@code title} attribute
		 */
		@SuppressWarnings(&quot;checkstyle:MultipleStringLiterals&quot;)
		private String formatNominationResultTitle(final LocalNominationResult result) {
<span class="fc" id="L270">			final int numberOfBallots = this.result.getBallots(result.getNomination().getDistrict()).size();</span>
<span class="fc" id="L271">			final StringBuilder builder = new StringBuilder(String.format(Locale.GERMAN, &quot;Anteil: %.1f %%&quot;, BigDecimals.divideOrZero(HUNDRED * result.getNumberOfVotes(), numberOfBallots, 1)));</span>
			//
			//
<span class="fc" id="L274">			result.getNomination().getParty().map(party -&gt; String.format(&quot;\nListenposition %d der %s&quot;, new ArrayList&lt;&gt;(this.result.getElection().getNominations(party)).indexOf(result.getNomination()) + 1, party.getShortName())).ifPresent(builder::append);</span>
<span class="fc" id="L275">			result.getSainteLagueValue().map(sainteLagueValue -&gt; String.format(Locale.GERMAN, &quot;\nSainte-Laguë-Höchstzahl: %.&quot; + sainteLagueValue.scale() + &quot;f&quot;, sainteLagueValue)).ifPresent(builder::append);</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">			for (final LocalPollingStation pollingStation : result.getNomination().getDistrict().getChildren()) {</span>
<span class="fc" id="L277">				final long numberOfVotesInPollingStation = result.getBallots().stream().filter(ballot -&gt; ballot.getPollingStation().equals(pollingStation)).count();</span>
<span class="fc" id="L278">				final long numberOfBallotsInPollingStation = this.result.getBallots(pollingStation).size();</span>
<span class="fc" id="L279">				builder.append(String.format(Locale.GERMAN, &quot;\n\n%s: %.1f %%\nStimmen: %d&quot;, pollingStation.getName(), BigDecimals.divideOrZero(HUNDRED * numberOfVotesInPollingStation, numberOfBallotsInPollingStation, 1), numberOfVotesInPollingStation));</span>
<span class="fc" id="L280">			}</span>
<span class="fc" id="L281">			return builder.toString();</span>
		}

		/**
		 * Formats the party results overview based on all party results and a section
		 * of the elected non-party nominations.
		 *
		 * @return the party results overview
		 */
		private String formatPartyResults() {
<span class="fc" id="L291">			final int numberOfAllVotes = this.result.getBallots().stream().filter(LocalBallot::isValid).map(LocalBallot::getNominations).mapToInt(Set::size).sum();</span>
<span class="fc" id="L292">			final String formattedParties = result.getPartyResults().values().stream().map(partyResult -&gt; formatPartyResult(partyResult, numberOfAllVotes)).collect(joining());</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">			final Set&lt;LocalNominationResult&gt; nominationResultsWithoutParty = result.getNominationResults().values().stream().filter(nominationResult -&gt; !nominationResult.getNomination().getParty().isPresent()).collect(toLinkedHashSet());</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">			if (nominationResultsWithoutParty.isEmpty()) {</span>
<span class="fc" id="L295">				return formattedParties;</span>
			}
<span class="nc" id="L297">			return formattedParties + formatPartyResult(Color.BLACK, Color.WHITE, &quot;&quot;, &quot;parteilos&quot;, (int) nominationResultsWithoutParty.stream().filter(nominationResult -&gt; nominationResult.getType().isElected()).count(), nominationResultsWithoutParty.stream().mapToInt(LocalNominationResult::getNumberOfVotes).sum(), numberOfAllVotes, nominationResultsWithoutParty);</span>
		}

		/**
		 * Formats the given party {@code result}.
		 *
		 * @param result           the party result to format
		 * @param numberOfAllVotes the sum of votes of all valid ballots
		 * @return the formatted party result
		 */
		private String formatPartyResult(final LocalPartyResult result, final int numberOfAllVotes) {
<span class="fc" id="L308">			return formatPartyResult(result.getParty().getBackgroundColor(), result.getParty().getFontColor(), formatPartyResultTitle(result), result.getParty().getShortName(), result.getNumberOfCertainSeats(), result.getNumberOfVotes(), numberOfAllVotes, result.getNominationResults().values());</span>
		}

		/**
		 * Formats the given data as party result.
		 *
		 * @param backgroundColor   the background color
		 * @param fontColor         the font color
		 * @param title             the content of the title attribute
		 * @param name              the name to display
		 * @param numberOfSeats     the number of seats of this party
		 * @param numberOfVotes     the number of votes of this party
		 * @param numberOfAllVotes  the sum of votes of all valid ballots
		 * @param nominationResults the nomination results of this party
		 * @return the formatted party result
		 */
		@SuppressWarnings(&quot;checkstyle:ParameterNumber&quot;)
		private String formatPartyResult(final Color backgroundColor, final Color fontColor, final String title, final String name, final int numberOfSeats, final int numberOfVotes, final int numberOfAllVotes, final Collection&lt;LocalNominationResult&gt; nominationResults) {
<span class="fc" id="L326">			return String.format(Locale.ROOT, TEMPLATE_PARTY_RESULT.get(), backgroundColor.toHex(), fontColor.toHex(), encodeXml(title), encodeXml(name), numberOfSeats, BigDecimals.format(BigDecimals.divideOrZero(HUNDRED * numberOfVotes, numberOfAllVotes, 1), 1, Locale.GERMAN), nominationResults.stream().filter(nominationResult -&gt; nominationResult.getType().isElected()).map(nominationResult -&gt; &quot;&lt;li&gt;&quot; + encodeXml(nominationResult.getNomination().getPerson().getKey()) + &quot;&lt;/li&gt;&quot;).collect(joining()));</span>
		}

		/**
		 * Formats the {@code title} attribute for the given party {@code result}.
		 *
		 * @param result the party result to format
		 * @return the formatted party result {@code title} attribute
		 */
		@SuppressWarnings({&quot;checkstyle:MultipleStringLiterals&quot;, &quot;PMD.InsufficientStringBufferDeclaration&quot;})
		private String formatPartyResultTitle(final LocalPartyResult result) {
<span class="fc" id="L337">			final StringBuilder builder = new StringBuilder(String.format(&quot;%s\n%d Stimmen\ndavon %d Blockstimmen&quot;, result.getParty().getName(), result.getNumberOfVotes(), result.getNumberOfBlockVotings() * Math.min(this.result.getElection().getNumberOfDirectSeatsPerLocalDistrict(), this.result.getElection().getNominations(result.getParty()).size())));</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">			for (final LocalPollingStation pollingStation : this.result.getElection().getPollingStations()) {</span>
<span class="fc" id="L339">				final long numberOfPartyVotesInPollingStation = result.getBallots().stream().filter(ballot -&gt; ballot.getPollingStation().equals(pollingStation)).mapToLong(ballot -&gt; ballot.getNominations().stream().filter(nomination -&gt; nomination.getParty().filter(result.getParty()::equals).isPresent()).count()).sum();</span>
<span class="fc" id="L340">				final int numberOfVotesInPollingStation = this.result.getNumberOfVotes(pollingStation);</span>
<span class="fc" id="L341">				builder.append(String.format(Locale.GERMAN, &quot;\n\n%s: %.1f %%\nStimmen: %d&quot;, pollingStation.getName(), BigDecimals.divideOrZero(HUNDRED * numberOfPartyVotesInPollingStation, numberOfVotesInPollingStation, 1), numberOfPartyVotesInPollingStation));</span>
<span class="fc" id="L342">			}</span>
<span class="fc" id="L343">			return builder.toString();</span>
		}

		@java.lang.SuppressWarnings(&quot;all&quot;)
		@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
		@lombok.Generated
		public PresentationFileWriter(final LocalElectionResult result, final Optional&lt;Duration&gt; refreshRate, final Writer writer) {
			this.result = result;
			this.refreshRate = refreshRate;
			this.writer = writer;
		}
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private PresentationFiles() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>