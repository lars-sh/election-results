<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AwgWebsiteFiles.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Election Results Core</a> &gt; <a href="index.source.html" class="el_package">de.larssh.election.germany.schleswigholstein.local.file</a> &gt; <span class="el_source">AwgWebsiteFiles.java</span></div><h1>AwgWebsiteFiles.java</h1><pre class="source lang-java linenums">// Generated by delombok at Wed Mar 01 00:41:54 UTC 2023
package de.larssh.election.germany.schleswigholstein.local.file;

import static java.util.stream.Collectors.joining;
import java.io.IOException;
import java.io.UncheckedIOException;
import java.io.Writer;
import java.lang.invoke.MethodHandles;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.function.Supplier;
import java.util.regex.Pattern;
import de.larssh.election.germany.schleswigholstein.Party;
import de.larssh.election.germany.schleswigholstein.local.LocalElectionResult;
import de.larssh.election.germany.schleswigholstein.local.LocalNominationType;
import de.larssh.election.germany.schleswigholstein.local.LocalPollingStation;
import de.larssh.utils.Finals;
import de.larssh.utils.OptionalInts;
import de.larssh.utils.annotations.PackagePrivate;
import de.larssh.utils.io.Resources;
import de.larssh.utils.text.Strings;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * This class contains helper methods to write a result file for the AWG
 * website.
 */
public final class AwgWebsiteFiles {
	/**
	 * Formats and writes {@code result} to {@code writer}.
	 *
	 * @param result the election result to to write
	 * @param writer the AWG website file writer
	 * @throws IOException on IO error
	 */
	public static void write(final LocalElectionResult result, final Writer writer) throws IOException {
<span class="fc" id="L38">		new AwgWebsiteFileWriter(result, writer).write();</span>
<span class="fc" id="L39">	}</span>


	/**
	 * This class writes data of a {@link LocalElectionResult} to a AWG website
	 * file.
	 */
	private static class AwgWebsiteFileWriter {
		/**
		 * Delimiter between PHP array entries
		 */
		private static final String PHP_ARRAY_ENTRIES_DELIMITER = &quot;,\n&quot;;
		/**
		 * Prefix to start PHP array entries with
		 */
		@SuppressWarnings(&quot;checkstyle:MultipleStringLiterals&quot;)
		private static final String PHP_ARRAY_ENTRIES_PREFIX = &quot;\n&quot;;
		/**
		 * Suffix to end PHP array entries with
		 */
		private static final String PHP_ARRAY_ENTRIES_SUFFIX = &quot;\n\t&quot;;
		/**
		 * Pattern matching sequences to convert to replace with a dash when stripping
		 * down a value to a PHP compatible identifier.
		 */
<span class="fc" id="L64">		private static final Pattern PHP_IDENTIFIER_MAKE_DASH = Pattern.compile(&quot;[^a-z0-9]+&quot;);</span>
		/**
		 * Pattern matching sequences to remove when stripping down a value to a PHP
		 * compatible identifier.
		 */
<span class="fc" id="L69">		private static final Pattern PHP_IDENTIFIER_REMOVE = Pattern.compile(&quot;(^[-0-9]+)|(-+$)&quot;);</span>
		/**
		 * PHP reserved literal for {@code null}
		 */
		private static final String PHP_NULL = &quot;null&quot;;
		/**
		 * Character to start and end a PHP string literal with
		 */
		private static final String PHP_STRING_LITERAL = &quot;\'&quot;;
		/**
		 * Template file body (lazily loaded)
		 */
<span class="fc" id="L81">		private static final Supplier&lt;String&gt; TEMPLATE = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template.php&quot;));</span>
		/**
		 * Template file body for a person object (lazily loaded)
		 */
<span class="fc" id="L85">		private static final Supplier&lt;String&gt; TEMPLATE_PERSONS = Finals.lazy(() -&gt; loadResourceRelativeToClass(&quot;template-person.php&quot;));</span>

		/**
		 * Creates a PHP string literal with a stripped-down {@code value} to be used
		 * for identifiers.
		 *
		 * @param value the value to strip down
		 * @return a PHP string literal with a stripped-down {@code value} to be used
		 *         for identifiers
		 */
		@SuppressWarnings(&quot;checkstyle:MultipleStringLiterals&quot;)
		private static String createPhpIdentifier(final String value) {
<span class="fc" id="L97">			String identifier = Strings.toLowerCaseNeutral(value).replace(&quot;ä&quot;, &quot;ae&quot;).replace(&quot;ö&quot;, &quot;oe&quot;).replace(&quot;ü&quot;, &quot;ue&quot;).replace(&quot;ß&quot;, &quot;ss&quot;);</span>
<span class="fc" id="L98">			identifier = Strings.replaceAll(identifier, PHP_IDENTIFIER_MAKE_DASH, &quot;-&quot;);</span>
<span class="fc" id="L99">			identifier = Strings.replaceAll(identifier, PHP_IDENTIFIER_REMOVE, &quot;&quot;);</span>
<span class="fc" id="L100">			return PHP_STRING_LITERAL + identifier + PHP_STRING_LITERAL;</span>
		}

		/**
		 * Creates a PHP string literal representing {@code value}.
		 *
		 * @param value the value to represent
		 * @return a PHP string literal representing {@code value}
		 */
		private static String createPhpString(final String value) {
<span class="fc" id="L110">			return PHP_STRING_LITERAL + value.replace(&quot;\r&quot;, &quot;\\r&quot;).replace(&quot;\n&quot;, &quot;\\n&quot;).replace(&quot;\\&quot;, &quot;\\\\&quot;).replace(PHP_STRING_LITERAL, &quot;\\\'&quot;) + PHP_STRING_LITERAL;</span>
		}

		/**
		 * Loads a resource from a folder next to this class. The file name is build by
		 * concatenating the class name, a dash and {@code fileNameSuffix}.
		 *
		 * @param fileNameSuffix the file name's suffix
		 * @return the resource file content
		 */
		@SuppressFBWarnings(value = {&quot;EXS_EXCEPTION_SOFTENING_NO_CONSTRAINTS&quot;, &quot;PATH_TRAVERSAL_IN&quot;}, justification = &quot;IOExceptions in here are not expected to be related to user input or behavior and fileNameSuffix is expected to be a constant value within this class.&quot;)
		private static String loadResourceRelativeToClass(final String fileNameSuffix) {
<span class="fc" id="L122">			final Class&lt;?&gt; clazz = MethodHandles.lookup().lookupClass();</span>
<span class="fc" id="L123">			final String fileName = clazz.getSimpleName() + &quot;-&quot; + fileNameSuffix;</span>
<span class="pc" id="L124">			final Path path = Resources.getResourceRelativeTo(clazz, Paths.get(fileName)).orElseThrow(() -&gt; new RuntimeException(String.format(&quot;Could not load \&quot;%s\&quot; from resources.&quot;, fileName)));</span>
			try {
<span class="fc" id="L126">				return new String(Files.readAllBytes(path), Strings.DEFAULT_CHARSET);</span>
<span class="nc" id="L127">			} catch (final IOException e) {</span>
<span class="nc" id="L128">				throw new UncheckedIOException(e);</span>
			}
		}

		/**
		 * Election Result to write
		 *
		 * @return the election result to write
		 */
		private final LocalElectionResult result;
		/**
		 * AWG website file writer
		 *
		 * @return the AWG website file writer
		 */
		private final Writer writer;

		/**
		 * Formats and writes {@link #result} to {@link #writer}.
		 *
		 * @throws IOException on IO error
		 */
		@PackagePrivate
		void write() throws IOException {
<span class="fc" id="L152">			writer.write(String.format(TEMPLATE.get(), result.getElection().getDate(), OptionalInts.mapToObj(result.getElection().getNumberOfEligibleVoters(), Integer::toString).orElse(PHP_NULL), OptionalInts.mapToObj(result.getNumberOfAllBallots(), Integer::toString).orElse(PHP_NULL), result.getNumberOfPostalBallots(), result.getNumberOfInvalidBallots(), formatData(), formatPersons(), formatSeats(), formatTypes()));</span>
<span class="fc" id="L153">		}</span>

		/**
		 * Returns PHP array entries by polling station for the &quot;data&quot; array. An
		 * identifier is generated out of the polling station's name, referencing an
		 * object with its direct nominations and their number of votes.
		 *
		 * @return the PHP array entries
		 */
		private String formatData() {
<span class="fc" id="L163">			return result.getElection().getPollingStations().stream().map(pollingStation -&gt; String.format(&quot;\t\t%s =&gt; array(%s)&quot;, createPhpIdentifier(pollingStation.getName()), formatNominationVotes(pollingStation))).collect(joining(PHP_ARRAY_ENTRIES_DELIMITER, PHP_ARRAY_ENTRIES_PREFIX, PHP_ARRAY_ENTRIES_SUFFIX));</span>
		}

		/**
		 * Returns PHP array entries by the nominations of {@code pollingStation} for
		 * the objects inside the &quot;data&quot; array. An identifier is generated out of the
		 * nomination's key, referencing its number of votes.
		 *
		 * @param pollingStation the polling station
		 * @return the PHP array entries
		 */
		private String formatNominationVotes(final LocalPollingStation pollingStation) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">			return result.filterByDistrict(pollingStation).getNominationResults().values().stream().filter(nominationResult -&gt; nominationResult.getNomination().getType() == LocalNominationType.DIRECT).map(nominationResult -&gt; String.format(&quot;\t\t\t%s =&gt; %d&quot;, createPhpIdentifier(nominationResult.getNomination().getPerson().getKey()), nominationResult.getNumberOfVotes())).collect(joining(PHP_ARRAY_ENTRIES_DELIMITER, PHP_ARRAY_ENTRIES_PREFIX, PHP_ARRAY_ENTRIES_SUFFIX + '\t'));</span>
		}

		/**
		 * Returns PHP array entries by nomination for the &quot;persons&quot; array. An
		 * identifier is generated out of the nomination's key, referencing an object
		 * with its party, family name and given name.
		 *
		 * @return the PHP array entries
		 */
		private String formatPersons() {
<span class="fc" id="L186">			return result.getElection().getNominations().stream().map(nomination -&gt; String.format(TEMPLATE_PERSONS.get(), createPhpIdentifier(nomination.getPerson().getKey()), nomination.getParty().map(Party::getShortName).map(AwgWebsiteFileWriter::createPhpIdentifier).orElse(PHP_NULL), createPhpString(nomination.getPerson().getFamilyName()), createPhpString(nomination.getPerson().getGivenName()))).collect(joining(PHP_ARRAY_ENTRIES_DELIMITER, PHP_ARRAY_ENTRIES_PREFIX, PHP_ARRAY_ENTRIES_SUFFIX));</span>
		}

		/**
		 * Returns PHP array entries by party for the &quot;seats&quot; array. An identifier is
		 * generated out of the party's short name, referencing its number of seats.
		 *
		 * @return the PHP array entries
		 */
		private String formatSeats() {
<span class="fc" id="L196">			return result.getPartyResults().values().stream().map(partyResult -&gt; String.format(&quot;\t\t%s =&gt; %d&quot;, createPhpIdentifier(partyResult.getParty().getShortName()), partyResult.getNumberOfSeats())).collect(joining(PHP_ARRAY_ENTRIES_DELIMITER, PHP_ARRAY_ENTRIES_PREFIX, PHP_ARRAY_ENTRIES_SUFFIX));</span>
		}

		/**
		 * Returns PHP array entries by polling station for the &quot;types&quot; array. An
		 * identifier is generated out of the polling station's name, referencing its
		 * name.
		 *
		 * @return the PHP array entries
		 */
		private String formatTypes() {
<span class="fc" id="L207">			return result.getElection().getPollingStations().stream().map(pollingStation -&gt; String.format(&quot;\t\t%s =&gt; %s&quot;, createPhpIdentifier(pollingStation.getName()), createPhpString(pollingStation.getName()))).collect(joining(PHP_ARRAY_ENTRIES_DELIMITER, PHP_ARRAY_ENTRIES_DELIMITER, &quot;&quot;));</span>
		}

		@java.lang.SuppressWarnings(&quot;all&quot;)
		@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
		@lombok.Generated
		public AwgWebsiteFileWriter(final LocalElectionResult result, final Writer writer) {
			this.result = result;
			this.writer = writer;
		}
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	private AwgWebsiteFiles() {
		throw new java.lang.UnsupportedOperationException(&quot;This is a utility class and cannot be instantiated&quot;);
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>