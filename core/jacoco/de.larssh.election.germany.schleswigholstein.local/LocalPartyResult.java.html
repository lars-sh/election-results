<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LocalPartyResult.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Election Results Core</a> &gt; <a href="index.source.html" class="el_package">de.larssh.election.germany.schleswigholstein.local</a> &gt; <span class="el_source">LocalPartyResult.java</span></div><h1>LocalPartyResult.java</h1><pre class="source lang-java linenums">// Generated by delombok at Mon Jan 30 16:27:36 UTC 2023
package de.larssh.election.germany.schleswigholstein.local;

import static de.larssh.utils.Collectors.toLinkedHashMap;
import static de.larssh.utils.Finals.lazy;
import static java.util.Collections.unmodifiableList;
import static java.util.stream.Collectors.toList;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.OptionalInt;
import java.util.function.Supplier;
import de.larssh.election.germany.schleswigholstein.Ballot;
import de.larssh.election.germany.schleswigholstein.Election;
import de.larssh.election.germany.schleswigholstein.Party;
import de.larssh.election.germany.schleswigholstein.PartyResult;
import de.larssh.utils.annotations.PackagePrivate;
import edu.umd.cs.findbugs.annotations.Nullable;

/**
 * Wahlergebnis einzelner politischer Parteien und Wählergruppen
 */
public class LocalPartyResult implements PartyResult&lt;LocalBallot&gt;, Comparable&lt;LocalPartyResult&gt; {
	/**
	 * Comparator by election, number of votes (high to low) and party
	 */
<span class="fc" id="L27">	private static final Comparator&lt;LocalPartyResult&gt; COMPARATOR = Comparator.&lt;LocalPartyResult, Election&lt;?, ?&gt;&gt;comparing(LocalPartyResult::getElection).reversed().thenComparing(LocalPartyResult::getNumberOfVotes).reversed().thenComparing(LocalPartyResult::getParty);</span>
	/**
	 * Wahlergebnis
	 */
	private final LocalElectionResult electionResult;
	/**
	 * Politische Partei oder Wählerguppe
	 */
	private final Party party;
	/**
	 * Stimmzettel mit Stimmen für diese politische Partei oder Wählerguppe
	 */
<span class="fc" id="L39">	private final Supplier&lt;List&lt;LocalBallot&gt;&gt; ballots = lazy(() -&gt; unmodifiableList(getElectionResult().getBallots().stream().filter(Ballot::isValid).filter(ballot -&gt; ballot.getNominations().stream().anyMatch(nomination -&gt; nomination.getParty().filter(getParty()::equals).isPresent())).collect(toList())));</span>
	/**
	 * Anzahl der Blockstimmen für diese politische Partei oder Wählerguppe
	 */
<span class="fc" id="L43">	private final Supplier&lt;Integer&gt; numberOfBlockVotings = lazy(() -&gt; (int) getBallots().stream().filter(LocalBallot::isBlockVoting).count());</span>
	/**
	 * Anzahl der Sitze für diese politische Partei oder Wählerguppe
	 */
<span class="fc bfc" id="L47" title="All 4 branches covered.">	private final Supplier&lt;Integer&gt; numberOfSeats = lazy(() -&gt; (int) getElectionResult().getNominationResults().values().stream().filter(nominationResult -&gt; nominationResult.getType().isElected() &amp;&amp; nominationResult.getNomination().getParty().filter(getParty()::equals).isPresent()).count());</span>
	/**
	 * Anzahl der Stimmen für diese politische Partei oder Wählerguppe
	 */
<span class="fc" id="L51">	private final Supplier&lt;Integer&gt; numberOfVotes = lazy(() -&gt; getNominationResults().values().stream().mapToInt(nominationResult -&gt; nominationResult.getBallots().size()).sum());</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int compareTo(@Nullable final LocalPartyResult partyResult) {
<span class="fc" id="L58">		return COMPARATOR.compare(this, partyResult);</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public List&lt;LocalBallot&gt; getBallots() {
<span class="fc" id="L66">		return ballots.get();</span>
	}

	/**
	 * Wahl
	 *
	 * @return Wahl
	 */
	private LocalElection getElection() {
<span class="fc" id="L75">		return getElectionResult().getElection();</span>
	}

	/**
	 * Bewerberinnen und Bewerber der Gruppierung
	 *
	 * @return Bewerberinnen und Bewerber
	 */
	public Map&lt;LocalNomination, LocalNominationResult&gt; getNominationResults() {
<span class="fc" id="L84">		return getElectionResult().getNominationResults().entrySet().stream().filter(entry -&gt; entry.getKey().getParty().filter(getParty()::equals).isPresent()).collect(toLinkedHashMap());</span>
	}

	/**
	 * Anzahl der Blockstimmen für diese politische Partei oder Wählerguppe
	 *
	 * @return Anzahl der Blockstimmen
	 */
	public int getNumberOfBlockVotings() {
<span class="fc" id="L93">		return numberOfBlockVotings.get();</span>
	}

	/**
	 * Determines the number of certain seats of this party.
	 *
	 * @return the number of certain seats of this party
	 */
	public int getNumberOfCertainSeats() {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">		if (getElection().getNominations().size() &lt;= getElection().getNumberOfSeats()) {</span>
<span class="nc" id="L103">			return getNumberOfSeats();</span>
		}
<span class="fc" id="L105">		return Math.max(getCertainDirectNominationResults().size(), getNumberOfCertainListSeats());</span>
	}

	/**
	 * Determines the party's direct nomination results, which are certain.
	 *
	 * @return the party's direct nomination results, which are certain
	 */
	@PackagePrivate
	Map&lt;LocalNomination, LocalNominationResult&gt; getCertainDirectNominationResults() {
<span class="fc" id="L115">		return getNominationResults().entrySet().stream().filter(entry -&gt; entry.getValue().isCertainDirectResult()).collect(toLinkedHashMap());</span>
	}

	/**
	 * Determines the number of certain list seats of this party, including possibly
	 * certain direct seats.
	 *
	 * @return the number of certain list seats of this party
	 */
	private int getNumberOfCertainListSeats() {
		// The number of all ballots is required to calculate the number of not yet
		// evaluated ballots.
<span class="fc" id="L127">		final OptionalInt numberOfAllBallots = getElectionResult().getNumberOfAllBallots();</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">		if (!numberOfAllBallots.isPresent()) {</span>
<span class="fc" id="L129">			return 0;</span>
		}
		// In case all ballots were evaluated we already know the precise result.
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">		if (getElectionResult().getBallots().size() &gt;= numberOfAllBallots.getAsInt()) {</span>
<span class="fc" id="L133">			return getNumberOfSeats();</span>
		}
		// Determine the number of all possible votes to use it as divisor.
<span class="nc" id="L136">		final long numberOfAllPossibleVotes = getElectionResult().getNumberOfVotes() + (numberOfAllBallots.getAsInt() - getElectionResult().getBallots().size()) * Math.min(getElection().getNumberOfVotesPerBallot(), getElection().getNominations(getParty()).size());</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		if (numberOfAllPossibleVotes == 0) {</span>
<span class="nc" id="L138">			return 0;</span>
		}
		// Determine the maximum percentage to be sure to get at least one seat (&quot;obere
		// natürliche Sperrklausel&quot;) based on the corresponding formula for Sainte Laguë
		// see https://www.wahlrecht.de/verfahren/faktische-sperrklausel.html
<span class="nc" id="L143">		final double maxPercentageForFirstSeat = 0.5 / (getElection().getNumberOfSeats() - 0.5 * getElection().getParties().size() + 1);</span>
		// Calculate the number of certain list seats in relation of the number of votes
		// for this party to all possible votes, taking care of the maximum percentage
		// for the first seat.
<span class="nc" id="L147">		final double percentageOfAllBallots = (double) getNumberOfVotes() / numberOfAllPossibleVotes;</span>
<span class="nc" id="L148">		return (int) Math.nextDown(getElection().getNumberOfSeats() * (percentageOfAllBallots - maxPercentageForFirstSeat) + 1);</span>
	}

	/**
	 * Calculates the maximum number of nominations, which are a candidate for
	 * {@link LocalNominationResultType#LIST}.
	 *
	 * @return the maximum number of list result candidates
	 */
	@PackagePrivate
	int getNumberOfListResultCandidates() {
		// The number of all ballots is required to calculate the number of not yet
		// evaluated ballots.
<span class="fc" id="L161">		final OptionalInt numberOfAllBallots = getElectionResult().getNumberOfAllBallots();</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">		if (!numberOfAllBallots.isPresent()) {</span>
<span class="nc" id="L163">			return 0;</span>
		}
		// In case all ballots were evaluated we already know the precise result.
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (getElectionResult().getBallots().size() &gt;= numberOfAllBallots.getAsInt()) {</span>
<span class="fc" id="L167">			return getNumberOfSeats();</span>
		}
		// Determine the maximum number of unevaluated votes to use it as divisor.
<span class="nc" id="L170">		final int numberOfPossiblyMissingVotes = (numberOfAllBallots.getAsInt() - getElectionResult().getBallots().size()) * Math.min(getElection().getNumberOfVotesPerBallot(), getElection().getNominations(getParty()).size());</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">		if (numberOfPossiblyMissingVotes == 0) {</span>
<span class="nc" id="L172">			return 0;</span>
		}
		// Determine the minimum percentage for the chance to get one seat (&quot;untere
		// natürliche Sperrklausel&quot;) based on the corresponding formula for Sainte Laguë
		// see https://www.wahlrecht.de/verfahren/faktische-sperrklausel.html
<span class="nc" id="L177">		final double minPercentageForFirstSeat = 0.5 / (getElection().getNumberOfSeats() + 0.5 * getElection().getParties().size() - 1);</span>
		// Calculate the number of list result candidates, taking care of the minimum
		// percentage for the first seat.
<span class="nc" id="L180">		final double percentageOfAllBallots = (double) (getNumberOfVotes() + numberOfPossiblyMissingVotes) / (getElectionResult().getNumberOfVotes() + numberOfPossiblyMissingVotes);</span>
<span class="nc" id="L181">		return (int) Math.nextUp(getElection().getNumberOfSeats() * (percentageOfAllBallots - minPercentageForFirstSeat) + 1);</span>
	}

	/**
	 * Anzahl der Sitze für diese politische Partei oder Wählerguppe
	 *
	 * @return Anzahl der Sitze
	 */
	public int getNumberOfSeats() {
<span class="fc" id="L190">		return numberOfSeats.get();</span>
	}

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int getNumberOfVotes() {
<span class="fc" id="L198">		return numberOfVotes.get();</span>
	}

	/**
	 * Wahlergebnis
	 *
	 * @return Wahlergebnis
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public LocalElectionResult getElectionResult() {
		return this.electionResult;
	}

	/**
	 * Politische Partei oder Wählerguppe
	 *
	 * @return Politische Partei oder Wählerguppe
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public Party getParty() {
		return this.party;
	}

	@edu.umd.cs.findbugs.annotations.NonNull
	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public java.lang.String toString() {
		return &quot;LocalPartyResult(party=&quot; + this.getParty() + &quot;, numberOfBlockVotings=&quot; + this.getNumberOfBlockVotings() + &quot;, numberOfSeats=&quot; + this.getNumberOfSeats() + &quot;, numberOfVotes=&quot; + this.getNumberOfVotes() + &quot;)&quot;;
	}

	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public boolean equals(@edu.umd.cs.findbugs.annotations.Nullable final java.lang.Object o) {
		if (o == this) return true;
		if (!(o instanceof LocalPartyResult)) return false;
		final LocalPartyResult other = (LocalPartyResult) o;
		if (!other.canEqual((java.lang.Object) this)) return false;
		if (this.getNumberOfVotes() != other.getNumberOfVotes()) return false;
		final java.lang.Object this$party = this.getParty();
		final java.lang.Object other$party = other.getParty();
		if (this$party == null ? other$party != null : !this$party.equals(other$party)) return false;
		final java.lang.Object this$$getElection = this.getElection();
		final java.lang.Object other$$getElection = other.getElection();
		if (this$$getElection == null ? other$$getElection != null : !this$$getElection.equals(other$$getElection)) return false;
		return true;
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	protected boolean canEqual(@edu.umd.cs.findbugs.annotations.Nullable final java.lang.Object other) {
		return other instanceof LocalPartyResult;
	}

	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public int hashCode() {
		final int PRIME = 59;
		int result = 1;
		result = result * PRIME + this.getNumberOfVotes();
		final java.lang.Object $party = this.getParty();
		result = result * PRIME + ($party == null ? 43 : $party.hashCode());
		final java.lang.Object $$getElection = this.getElection();
		result = result * PRIME + ($$getElection == null ? 43 : $$getElection.hashCode());
		return result;
	}

	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	LocalPartyResult(final LocalElectionResult electionResult, final Party party) {
		this.electionResult = electionResult;
		this.party = party;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>