<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LocalBallot.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Election Results CLI</a> &gt; <a href="../index.html" class="el_bundle">election-results-core</a> &gt; <a href="index.source.html" class="el_package">de.larssh.election.germany.schleswigholstein.local</a> &gt; <span class="el_source">LocalBallot.java</span></div><h1>LocalBallot.java</h1><pre class="source lang-java linenums">// Generated by delombok at Thu Feb 23 23:23:12 UTC 2023
package de.larssh.election.germany.schleswigholstein.local;

import static de.larssh.utils.Collectors.toLinkedHashSet;
import static de.larssh.utils.Finals.lazy;
import static java.util.Collections.emptySet;
import static java.util.Collections.unmodifiableSet;
import static java.util.stream.Collectors.joining;
import static java.util.stream.Collectors.toList;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.TreeSet;
import java.util.function.Supplier;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonProperty;
import de.larssh.election.germany.schleswigholstein.Ballot;
import de.larssh.election.germany.schleswigholstein.ElectionException;
import de.larssh.election.germany.schleswigholstein.Party;
import edu.umd.cs.findbugs.annotations.Nullable;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;

/**
 * Stimmzettel
 */
@SuppressWarnings(&quot;PMD.DataClass&quot;)
public final class LocalBallot implements Ballot&lt;LocalNomination&gt;, Comparable&lt;LocalBallot&gt; {
	/**
	 * Comparator by election, polling station, postal vote, validity, block voting
	 * and nominations
	 */
<span class="fc" id="L34">	private static final Comparator&lt;LocalBallot&gt; COMPARATOR = Comparator.comparing(LocalBallot::getElection).thenComparing(LocalBallot::getPollingStation).thenComparing(LocalBallot::isPostalVote).thenComparing(LocalBallot::isValid).thenComparing(LocalBallot::isBlockVoting).thenComparing((a, b) -&gt; {</span>
<span class="fc" id="L35">		final Iterator&lt;LocalNomination&gt; otherNomination = b.getNominations().iterator();</span>
<span class="fc bfc" id="L36" title="All 2 branches covered.">		for (final LocalNomination thisNomination : a.getNominations()) {</span>
<span class="fc bfc" id="L37" title="All 2 branches covered.">			if (!otherNomination.hasNext()) {</span>
<span class="fc" id="L38">				return 1;</span>
			}
<span class="fc" id="L40">			final int compare = thisNomination.compareTo(otherNomination.next());</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">			if (compare != 0) {</span>
<span class="fc" id="L42">				return compare;</span>
			}
<span class="fc" id="L44">		}</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">		return otherNomination.hasNext() ? -1 : 0;</span>
	});

	/**
	 * Creates an invalid ballot
	 *
	 * @param election       Wahl
	 * @param pollingStation Wahlbezirk
	 * @param postalVote     {@code true} for postal vote ballots, else
	 *                       {@code false}
	 * @return the new ballot
	 */
	public static LocalBallot createInvalidBallot(final LocalElection election, final LocalPollingStation pollingStation, final boolean postalVote) {
<span class="fc" id="L58">		return new LocalBallot(election, pollingStation, postalVote, false, emptySet());</span>
	}

	/**
	 * Creates a valid ballot
	 *
	 * @param election       Wahl
	 * @param pollingStation Wahlbezirk
	 * @param postalVote     {@code true} for postal vote ballots, else
	 *                       {@code false}
	 * @param nominations    gewählte Bewerberinnen und Bewerber
	 * @return the new ballot
	 */
	public static LocalBallot createValidBallot(final LocalElection election, final LocalPollingStation pollingStation, final boolean postalVote, final Set&lt;LocalNomination&gt; nominations) {
<span class="fc" id="L72">		return new LocalBallot(election, pollingStation, postalVote, true, nominations);</span>
	}

	/**
	 * Wahl
	 */
	@JsonIgnore
	private final LocalElection election;
	/**
	 * Wahlbezirk
	 */
	@JsonIgnore
	private final LocalPollingStation pollingStation;
	/**
	 * Briefwahl (§ 33 GKWG)
	 */
	private final boolean postalVote;
	/**
	 * Ungültige Stimme (§ 35 GKWG)
	 */
	private final boolean valid;
	/**
	 * Gewählte Bewerberinnen und Bewerber (§ 28 Absatz 2 GKWG)
	 */
	private final Set&lt;LocalNomination&gt; nominations;
	/**
	 * Blockwahl
	 */
<span class="fc" id="L100">	@JsonIgnore</span>
<span class="fc" id="L101">	private final Supplier&lt;Boolean&gt; blockVoting = lazy(() -&gt; {</span>
<span class="fc" id="L102">		final List&lt;Party&gt; parties = getNominations().stream().map(LocalNomination::getParty).filter(Optional::isPresent).map(Optional::get).distinct().limit(2).collect(toList());</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">		if (parties.size() != 1) {</span>
<span class="fc" id="L104">			return Boolean.FALSE;</span>
		}
<span class="fc bfc" id="L106" title="All 2 branches covered.">		final long directNominationsOfThatParty = getElection().getNominations(parties.get(0)).stream().filter(nomination -&gt; nomination.getType() == LocalNominationType.DIRECT).count();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">		return getNominations().size() == directNominationsOfThatParty;</span>
	});

	/**
	 * Stimmzettel
	 *
	 * @param election       Wahl
	 * @param pollingStation Wahlbezirk
	 * @param postalVote     {@code true} for postal vote ballots, else
	 *                       {@code false}
	 * @param valid          {@code true} for valid ballots, else {@code false}
	 * @param nominations    gewählte Bewerberinnen und Bewerber
	 */
<span class="fc" id="L120">	private LocalBallot(final LocalElection election, final LocalPollingStation pollingStation, final boolean postalVote, final boolean valid, final Set&lt;LocalNomination&gt; nominations) {</span>
<span class="fc" id="L121">		this.election = election;</span>
<span class="fc" id="L122">		this.pollingStation = pollingStation;</span>
<span class="fc" id="L123">		this.valid = valid;</span>
<span class="fc" id="L124">		this.nominations = unmodifiableSet(new TreeSet&lt;&gt;(nominations));</span>
<span class="fc" id="L125">		this.postalVote = postalVote;</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">		if (valid) {</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">			if (nominations.size() &gt; election.getNumberOfVotesPerBallot()) {</span>
<span class="nc" id="L128">				throw new ElectionException(String.format(&quot;Ballot of election \&quot;%s\&quot; contains more (%d) nominations than permitted (%d). Nominations are: %s&quot;, election.getName(), nominations.size(), election.getNumberOfVotesPerBallot(), this.nominations.stream().map(nomination -&gt; nomination.getPerson().getGivenName() + ' ' + nomination.getPerson().getFamilyName()).collect(joining(&quot;, &quot;))));</span>
			}
<span class="fc bfc" id="L130" title="All 2 branches covered.">			for (final LocalNomination nomination : this.nominations) {</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">				if (!nomination.getElection().equals(election)) {</span>
<span class="nc" id="L132">					throw new ElectionException(&quot;Election \&quot;%s\&quot; of nomination \&quot;%s, %s\&quot; does not match election \&quot;%s\&quot; of ballot.&quot;, nomination.getElection().getName(), nomination.getPerson().getFamilyName(), nomination.getPerson().getGivenName(), election.getName());</span>
				}
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">				if (nomination.getType() != LocalNominationType.DIRECT) {</span>
<span class="nc" id="L135">					throw new ElectionException(&quot;Nomination \&quot;%s, %s\&quot; of election \&quot;%s\&quot; is not a direct nomination. Ballots can contain direct nominations only.&quot;, nomination.getPerson().getFamilyName(), nomination.getPerson().getGivenName(), election.getName());</span>
				}
<span class="fc" id="L137">			}</span>
		}
<span class="fc" id="L139">	}</span>

	/**
	 * {@inheritDoc}
	 */
	@Override
	public int compareTo(@Nullable final LocalBallot ballot) {
<span class="fc" id="L146">		return COMPARATOR.compare(this, ballot);</span>
	}

	/**
	 * Nominations as JSON property
	 *
	 * @return Gewählte Bewerberinnen und Bewerber
	 */
	@JsonProperty(&quot;nominations&quot;)
	@SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
	@SuppressFBWarnings(value = &quot;UPM_UNCALLED_PRIVATE_METHOD&quot;, justification = &quot;JSON property&quot;)
	private Set&lt;String&gt; getNominationsForJackson() {
<span class="fc" id="L158">		return getNominations().stream().map(LocalNomination::getKey).collect(toLinkedHashSet());</span>
	}

	/**
	 * Polling station as JSON property
	 *
	 * @return Wahlbezirk
	 */
	@JsonProperty(&quot;pollingStation&quot;)
	@SuppressWarnings(&quot;PMD.UnusedPrivateMethod&quot;)
	@SuppressFBWarnings(value = &quot;UPM_UNCALLED_PRIVATE_METHOD&quot;, justification = &quot;JSON property&quot;)
	private String getPollingStationForJackson() {
<span class="fc" id="L170">		return getPollingStation().getKey();</span>
	}

	/**
	 * Blockwahl
	 *
	 * @return {@code true} if the ballot contains all and only nominations of
	 *         exactly one party, else {@code false}
	 */
	@JsonIgnore
	public boolean isBlockVoting() {
<span class="fc" id="L181">		return blockVoting.get();</span>
	}

	/**
	 * Wahl
	 *
	 * @return Wahl
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public LocalElection getElection() {
		return this.election;
	}

	/**
	 * Wahlbezirk
	 *
	 * @return Wahlbezirk
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public LocalPollingStation getPollingStation() {
		return this.pollingStation;
	}

	/**
	 * Briefwahl (§ 33 GKWG)
	 *
	 * @return {@code true} for postal vote ballots, else {@code false}
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public boolean isPostalVote() {
		return this.postalVote;
	}

	/**
	 * Ungültige Stimme (§ 35 GKWG)
	 *
	 * @return {@code true} for valid ballots, else {@code false}
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public boolean isValid() {
		return this.valid;
	}

	/**
	 * Gewählte Bewerberinnen und Bewerber (§ 28 Absatz 2 GKWG)
	 *
	 * @return Gewählte Bewerberinnen und Bewerber
	 */
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public Set&lt;LocalNomination&gt; getNominations() {
		return this.nominations;
	}

	@edu.umd.cs.findbugs.annotations.NonNull
	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public java.lang.String toString() {
		return &quot;LocalBallot(election=&quot; + this.getElection() + &quot;, pollingStation=&quot; + this.getPollingStation() + &quot;, postalVote=&quot; + this.isPostalVote() + &quot;, valid=&quot; + this.isValid() + &quot;, nominations=&quot; + this.getNominations() + &quot;)&quot;;
	}

	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public boolean equals(@edu.umd.cs.findbugs.annotations.Nullable final java.lang.Object o) {
		if (o == this) return true;
		if (!(o instanceof LocalBallot)) return false;
		final LocalBallot other = (LocalBallot) o;
		if (this.isPostalVote() != other.isPostalVote()) return false;
		if (this.isValid() != other.isValid()) return false;
		final java.lang.Object this$election = this.getElection();
		final java.lang.Object other$election = other.getElection();
		if (this$election == null ? other$election != null : !this$election.equals(other$election)) return false;
		final java.lang.Object this$pollingStation = this.getPollingStation();
		final java.lang.Object other$pollingStation = other.getPollingStation();
		if (this$pollingStation == null ? other$pollingStation != null : !this$pollingStation.equals(other$pollingStation)) return false;
		final java.lang.Object this$nominations = this.getNominations();
		final java.lang.Object other$nominations = other.getNominations();
		if (this$nominations == null ? other$nominations != null : !this$nominations.equals(other$nominations)) return false;
		return true;
	}

	@java.lang.Override
	@java.lang.SuppressWarnings(&quot;all&quot;)
	@edu.umd.cs.findbugs.annotations.SuppressFBWarnings(justification = &quot;generated code&quot;)
	@lombok.Generated
	public int hashCode() {
		final int PRIME = 59;
		int result = 1;
		result = result * PRIME + (this.isPostalVote() ? 79 : 97);
		result = result * PRIME + (this.isValid() ? 79 : 97);
		final java.lang.Object $election = this.getElection();
		result = result * PRIME + ($election == null ? 43 : $election.hashCode());
		final java.lang.Object $pollingStation = this.getPollingStation();
		result = result * PRIME + ($pollingStation == null ? 43 : $pollingStation.hashCode());
		final java.lang.Object $nominations = this.getNominations();
		result = result * PRIME + ($nominations == null ? 43 : $nominations.hashCode());
		return result;
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>